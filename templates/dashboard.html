<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExTrack - Modern Expense Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glassmorphism-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .card-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .card-modern:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .category-icon-modern {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .modal {
            display: none;
            position: fixed;
            /* increase z-index so modal overlays any transformed/stacked cards */
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 10% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlideIn {
            from { 
                transform: translateY(-60px) scale(0.95); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .input-modern {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }
        
        .input-modern:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .nav-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            /* make navbar sticky and above content cards but below modals */
            position: sticky;
            top: 0;
            z-index: 10000;
        }
        
        .expense-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .expense-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.8) 100%);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stats-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
        }
        
        
        .text-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #10b981;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .toast.info {
            border-left-color: #3b82f6;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .toast-icon.success { background: #10b981; }
        .toast-icon.error { background: #ef4444; }
        .toast-icon.warning { background: #f59e0b; }
        .toast-icon.info { background: #3b82f6; }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .toast-message {
            color: #64748b;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #64748b;
        }

        /* Hide browser date placeholder (e.g. dd-mm-yyyy) for search date input by default
           and show text when focused or when a value exists. Uses a helper class toggled by JS. */
        input.search-date {
            color: transparent;
        }

        input.search-date.has-value,
        input.search-date:focus {
            color: #1e293b; /* default text color when showing the selected date */
        }
        
        /* Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            /* keep confirmation above other modals/cards */
            z-index: 100000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .confirmation-modal.show {
            display: flex;
        }
        
        .confirmation-content {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }
        
        .confirmation-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #fef3c7;
            color: #f59e0b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 16px;
        }
        
        .confirmation-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .confirmation-message {
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .btn-confirm {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-confirm:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .btn-cancel {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-cancel:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
    </style>
</head>
<body class="min-h-screen" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #3b82f6 100%); background-attachment: fixed;">
    <!-- Navigation Header -->
    <nav class="nav-glass shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Left side - Profile / User Info (improved) -->
                <div class="relative">
                    <button id="profileBtn" class="flex items-center space-x-3 focus:outline-none">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center text-white shadow-md">
                            <span id="profileEmoji" class="text-lg" aria-hidden="true">üí†</span>
                        </div>
                        <div class="text-white hidden sm:block">
                            <p class="text-sm font-medium">{{ user.username }}</p>
                            <p class="text-xs text-white text-opacity-70">Welcome back</p>
                        </div>
                        <i class="fas fa-chevron-down text-white ml-2 hidden sm:block"></i>
                    </button>

                    <!-- Dropdown -->
                    <div id="profileDropdown" class="absolute left-0 mt-2 w-44 bg-white rounded-xl shadow-lg py-2 hidden overflow-hidden" style="z-index:11000;">
                        <a href="{% url 'overview' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Account</a>
                        <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
                
                    

                <!-- Center - Branding -->
                <div class="flex items-center">
                    <a href="{% url 'dashboard' %}" class="flex items-center hover:opacity-80 transition duration-300 group">
                        <div class="w-12 h-12 rounded-2xl bg-white bg-opacity-20 backdrop-blur-sm flex items-center justify-center mr-4 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-wallet text-white text-xl"></i>
                        </div>
                        <h1 class="text-white text-2xl font-bold tracking-tight">ExTrack</h1>
                    </a>
                </div>
                
                <!-- Right side - Navigation & Actions -->
                <div class="flex items-center space-x-6">
                    <a href="{% url 'overview' %}" class="text-white hover:text-gray-200 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 hover:bg-white hover:bg-opacity-10 backdrop-blur-sm">
                        <i class="fas fa-chart-pie mr-2"></i>Analytics
                    </a>
                    <a href="{% url 'dashboard' %}" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-xl text-sm font-medium backdrop-blur-sm">
                        <i class="fas fa-list mr-2"></i>Expenses
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-8 p-4 rounded-2xl backdrop-blur-sm border border-opacity-20
                    {% if message.tags == 'error' %}bg-red-500 bg-opacity-10 border-red-500 text-red-700
                    {% elif message.tags == 'success' %}bg-green-500 bg-opacity-10 border-green-500 text-green-700
                    {% else %}bg-blue-500 bg-opacity-10 border-blue-500 text-blue-700{% endif %}">
                    <div class="flex items-center">
                        <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} mr-3"></i>
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8 mb-12">
            <div class="stats-card rounded-3xl p-8">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-2">Total Expenses</p>
                        <p class="text-3xl font-bold text-gradient">‚Çπ{{ total_amount|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">All time</p>
                    </div>
                    <div class="category-icon-modern gradient-primary">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="openModal()" class="btn-primary text-white text-sm px-4 py-2 rounded-2xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add Expense
                    </button>
                </div>
            </div>
            <div class="stats-card rounded-3xl p-8">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-2">Total Items</p>
                        <p class="text-3xl font-bold text-gray-900">{{ expenses.count }}</p>
                        <p class="text-xs text-gray-500 mt-1">Transactions</p>
                    </div>
                    <div class="category-icon-modern gradient-success">
                        <i class="fas fa-list"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card rounded-3xl p-8">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-2">This Month</p>
                        <p class="text-3xl font-bold text-gray-900">‚Çπ{{ monthly_total|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">Current month</p>
                    </div>
                    <div class="category-icon-modern gradient-warning">
                        <i class="fas fa-calendar"></i>
                    </div>
                </div>
            </div>
            <div class="stats-card rounded-3xl p-8">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-2">Income</p>
                        <p class="text-3xl font-bold text-gray-900">‚Çπ{{ total_income|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">This month: ‚Çπ{{ monthly_income_total|default:0 }}</p>
                    </div>
                    <div class="category-icon-modern gradient-success">
                        <i class="fas fa-hand-holding-dollar"></i>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="openIncomeModal()" class="btn-primary text-white px-4 py-2 rounded-2xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add Income
                    </button>
                </div>
            </div>
            
            <!-- Budget Card -->
            <div class="stats-card rounded-3xl p-8">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 mb-2">Budget</p>
                        <p class="text-3xl font-bold text-gradient">‚Çπ{{ budget.amount|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            {% if budget.remaining_amount >= 0 %}
                                ‚Çπ{{ budget.remaining_amount|floatformat:2 }} left
                            {% else %}
                                ‚Çπ{{ budget.remaining_amount|floatformat:2 }} over
                            {% endif %}
                        </p>
                    </div>
                    <div class="category-icon-modern gradient-warning">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <!-- Budget Progress Bar -->
                <div class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full {% if budget.spent_percentage <= 50 %}bg-green-500{% elif budget.spent_percentage <= 80 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                             style="width: {{ budget.spent_percentage|floatformat:1 }}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">{{ budget.spent_percentage|floatformat:1 }}% spent</p>
                </div>
            </div>
        </div>

        <!-- Expenses Grid -->
        <div class="card-modern rounded-3xl p-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Your Expenses</h2>
                    <p class="text-gray-600">Track and manage your spending</p>
                </div>
                <!-- Search form: title/name, category, date -->
                <div class="flex-1 mx-6 flex justify-center items-center">
                    <form method="GET" action="{% url 'dashboard' %}" class="w-full max-w-2xl">
                        <div class="flex items-center bg-white rounded-full shadow-sm overflow-hidden px-1">
                            <input type="text" name="q" value="{{ request.GET.q|default_if_none:'' }}" placeholder="Search name or desc" class="flex-1 px-3 py-2 text-sm focus:outline-none" />
                            <select name="category" class="w-28 px-2 py-2 text-sm border-l border-gray-100 focus:outline-none bg-white">
                                <option value="">category</option>
                                <option value="food" {% if request.GET.category == 'food' %}selected{% endif %}>Food</option>
                                <option value="rent" {% if request.GET.category == 'rent' %}selected{% endif %}>Rent</option>
                                <option value="transport" {% if request.GET.category == 'transport' %}selected{% endif %}>Transport</option>
                                <option value="entertainment" {% if request.GET.category == 'entertainment' %}selected{% endif %}>Entertainment</option>
                                <option value="healthcare" {% if request.GET.category == 'healthcare' %}selected{% endif %}>Healthcare</option>
                                <option value="shopping" {% if request.GET.category == 'shopping' %}selected{% endif %}>Shopping</option>
                                <option value="utilities" {% if request.GET.category == 'utilities' %}selected{% endif %}>Utilities</option>
                                <option value="education" {% if request.GET.category == 'education' %}selected{% endif %}>Education</option>
                                <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
                            </select>
                            <div class="relative border-l border-gray-100">
                                <!-- <i class="fas fa-calendar absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i> -->
                                <input type="date" id="search_date" name="date" value="{{ request.GET.date|default_if_none:'' }}" placeholder="" class="search-date w-36 pl-9 pr-2 py-2 text-sm focus:outline-none bg-white" />
                            </div>
                            <button type="submit" class="ml-2 px-3 py-2 text-sm rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold">Search</button>
                        </div>
                    </form>
                </div>
                <div class="flex space-x-4">
                    <button onclick="openBudgetModal()" class="btn-primary text-white px-6 py-3 rounded-2xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-wallet mr-2"></i>Set Budget
                    </button>
                </div>
            </div>
            
            {% if expenses %}
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    {% for expense in expenses %}
                        <div class="expense-card rounded-xl p-4" data-expense-id="{{ expense.pk }}">
                            <div class="flex items-start justify-between mb-3">
                                <div class="category-icon-modern 
                                    {% if expense.category == 'food' %}gradient-success
                                    {% elif expense.category == 'rent' %}gradient-primary
                                    {% elif expense.category == 'transport' %}gradient-warning
                                    {% elif expense.category == 'entertainment' %}gradient-secondary
                                    {% elif expense.category == 'healthcare' %}bg-red-500
                                    {% elif expense.category == 'shopping' %}bg-pink-500
                                    {% elif expense.category == 'utilities' %}bg-indigo-500
                                    {% elif expense.category == 'education' %}bg-orange-500
                                    {% else %}bg-gray-500{% endif %}">
                                    {% if expense.category == 'food' %}<i class="fas fa-utensils"></i>
                                    {% elif expense.category == 'rent' %}<i class="fas fa-home"></i>
                                    {% elif expense.category == 'transport' %}<i class="fas fa-car"></i>
                                    {% elif expense.category == 'entertainment' %}<i class="fas fa-film"></i>
                                    {% elif expense.category == 'healthcare' %}<i class="fas fa-heartbeat"></i>
                                    {% elif expense.category == 'shopping' %}<i class="fas fa-shopping-bag"></i>
                                    {% elif expense.category == 'utilities' %}<i class="fas fa-bolt"></i>
                                    {% elif expense.category == 'education' %}<i class="fas fa-book"></i>
                                    {% else %}<i class="fas fa-tag"></i>{% endif %}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="openEditModal({{ expense.pk }})" class="w-6 h-6 rounded-md bg-blue-100 hover:bg-blue-200 text-blue-600 flex items-center justify-center transition-all duration-300 hover:scale-110" title="Edit">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button data-expense-id="{{ expense.pk }}" onclick="deleteExpense(this.dataset.expenseId)" class="w-6 h-6 rounded-md bg-red-100 hover:bg-red-200 text-red-600 flex items-center justify-center transition-all duration-300 hover:scale-110" title="Delete">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <h3 class="text-sm font-bold text-gray-900 mb-1">{{ expense.title }}</h3>
                            <p class="text-lg font-bold text-gradient mb-2">‚Çπ{{ expense.amount }}</p>
                            <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                <span class="flex items-center">
                                    <i class="fas fa-tag mr-2"></i>{{ expense.get_category_display }}
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-calendar mr-2"></i>{{ expense.date }}
                                </span>
                            </div>
                            {% if expense.description %}
                                <p class="text-sm text-gray-600 mt-3 p-3 bg-gray-50 rounded-xl">{{ expense.description }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center">
                        <i class="fas fa-receipt text-4xl text-gradient"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">No expenses yet</h3>
                    <p class="text-gray-600 mb-8 max-w-md mx-auto">Start tracking your expenses by adding your first transaction. It's easy and will help you understand your spending patterns.</p>
                    <button onclick="openModal()" class="btn-primary text-white px-8 py-4 rounded-2xl font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add Your First Expense
                    </button>
                </div>
            {% endif %}
        </div>
    </div>


    <!-- Add Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="gradient-primary px-6 py-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Add New Expense</h3>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white flex items-center justify-center transition-all duration-300 hover:scale-110">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form method="POST" action="{% url 'dashboard' %}" class="p-6">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                        <input type="text" id="title" name="title" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="Enter expense title">
                    </div>
                    
                    <div>
                        <label for="amount" class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                        <input type="number" step="0.01" id="amount" name="amount" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="0.00">
                    </div>
                    
                    <div>
                        <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <select id="category" name="category" required 
                                class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="food">üçΩÔ∏è Food & Dining</option>
                            <option value="rent">üè† Rent & Housing</option>
                            <option value="transport">üöó Transportation</option>
                            <option value="entertainment">üé¨ Entertainment</option>
                            <option value="healthcare">üè• Healthcare</option>
                            <option value="shopping">üõçÔ∏è Shopping</option>
                            <option value="utilities">‚ö° Utilities</option>
                            <option value="education">üìö Education</option>
                            <option value="other">üìù Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="date" class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                        <input type="date" id="date" name="date" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                        <textarea id="description" name="description" rows="2" 
                                  class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                                  placeholder="Add a description..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 font-semibold">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Add Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <div class="gradient-primary px-6 py-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Edit Expense</h3>
                    <button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white flex items-center justify-center transition-all duration-300 hover:scale-110">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="editExpenseForm" method="POST" class="p-6">
                {% csrf_token %}
                <input type="hidden" id="editExpenseId" name="expense_id">
                <div class="space-y-4">
                    <div>
                        <label for="editTitle" class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                        <input type="text" id="editTitle" name="title" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="Enter expense title">
                    </div>
                    
                    <div>
                        <label for="editAmount" class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                        <input type="number" step="0.01" id="editAmount" name="amount" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="0.00">
                    </div>
                    
                    <div>
                        <label for="editCategory" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                        <select id="editCategory" name="category" required 
                                class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="food">üçΩÔ∏è Food & Dining</option>
                            <option value="rent">üè† Rent & Housing</option>
                            <option value="transport">üöó Transportation</option>
                            <option value="entertainment">üé¨ Entertainment</option>
                            <option value="healthcare">üè• Healthcare</option>
                            <option value="shopping">üõçÔ∏è Shopping</option>
                            <option value="utilities">‚ö° Utilities</option>
                            <option value="education">üìö Education</option>
                            <option value="other">üìù Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="editDate" class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                        <input type="date" id="editDate" name="date" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="editDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                        <textarea id="editDescription" name="description" rows="2" 
                                  class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                                  placeholder="Add a description..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()" 
                            class="px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 font-semibold">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-save mr-2"></i>Update Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="gradient-warning px-6 py-4 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Set Budget</h3>
                    <button onclick="closeBudgetModal()" class="w-8 h-8 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white flex items-center justify-center transition-all duration-300 hover:scale-110">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <form method="POST" class="p-6">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label for="budget_amount" class="block text-sm font-semibold text-gray-700 mb-2">Budget Amount</label>
                        <input type="number" step="0.01" id="budget_amount" name="budget_amount" required 
                               class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                               placeholder="Enter your budget amount" value="{{ budget.amount|default:0 }}">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeBudgetModal()" 
                            class="px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 font-semibold">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                        <i class="fas fa-wallet mr-2"></i>Set Budget
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
        <!-- Income Modal -->
        <div id="incomeModal" class="modal">
            <div class="modal-content">
                <div class="gradient-success px-6 py-4 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Add Income</h3>
                        <button onclick="closeIncomeModal()" class="w-8 h-8 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white flex items-center justify-center transition-all duration-300 hover:scale-110">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <form method="POST" class="p-6">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label for="income_title" class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                            <input type="text" id="income_title" name="income_title" required 
                                   class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                   placeholder="Income source (e.g., salary)">
                        </div>
                        <div>
                            <label for="income_amount" class="block text-sm font-semibold text-gray-700 mb-2">Amount</label>
                            <input type="number" step="0.01" id="income_amount" name="income_amount" required 
                                   class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label for="income_date" class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                            <input type="date" id="income_date" name="income_date" required 
                                   class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="income_description" class="block text-sm font-semibold text-gray-700 mb-2">Description (Optional)</label>
                            <textarea id="income_description" name="income_description" rows="2" 
                                      class="input-modern w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                                      placeholder="Add a description..."></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeIncomeModal()" 
                                class="px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 font-semibold">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="btn-primary text-white px-6 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Add Income
                        </button>
                    </div>
                </form>
            </div>
        </div>
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="confirmation-title">Delete Expense</div>
            <div class="confirmation-message">Are you sure you want to delete this expense? This action cannot be undone.</div>
            <div class="confirmation-buttons">
                <button class="btn-cancel" onclick="closeConfirmationModal()">Cancel</button>
                <button class="btn-confirm" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        function openModal() {
            document.getElementById('expenseModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('expenseModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Edit Modal functions
        function openEditModal(expenseId) {
            // Fetch expense data
            fetch(`/edit/${expenseId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                // Populate form fields
                document.getElementById('editExpenseId').value = data.id;
                document.getElementById('editTitle').value = data.title;
                document.getElementById('editAmount').value = data.amount;
                document.getElementById('editCategory').value = data.category;
                document.getElementById('editDate').value = data.date;
                document.getElementById('editDescription').value = data.description;
                
                // Update form action
                document.getElementById('editExpenseForm').action = `/edit/${data.id}/`;
                
                // Show modal
                document.getElementById('editExpenseModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading expense data');
            });
        }

        function closeEditModal() {
            document.getElementById('editExpenseModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Budget Modal functions
        function openBudgetModal() {
            document.getElementById('budgetModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Income Modal functions
        function openIncomeModal() {
            document.getElementById('incomeModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeIncomeModal() {
            document.getElementById('incomeModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('expenseModal');
            const editModal = document.getElementById('editExpenseModal');
            const budgetModal = document.getElementById('budgetModal');
            const confirmationModal = document.getElementById('confirmationModal');
            
            if (event.target === modal) {
                closeModal();
            } else if (event.target === editModal) {
                closeEditModal();
            } else if (event.target === budgetModal) {
                closeBudgetModal();
            } else if (event.target === confirmationModal) {
                closeConfirmationModal();
            }
        }

        // Global variable to store expense ID for deletion (numeric)
        let expenseToDelete = null;

        // Delete expense function - receives id from data attribute (string) and validates it
        function deleteExpense(expenseId) {
            console.log('deleteExpense called with ID:', expenseId);

            // Normalize common invalid tokens
            if (expenseId === null || expenseId === undefined || expenseId === 'None' || expenseId === 'null' || expenseId === '') {
                showToast('Invalid expense ID. Please refresh the page.', 'error');
                return;
            }

            // Parse to integer and validate
            const id = parseInt(expenseId, 10);
            if (Number.isNaN(id) || id <= 0) {
                showToast('Invalid expense ID. Please refresh the page.', 'error');
                return;
            }

            expenseToDelete = id;
            console.log('expenseToDelete set to (number):', expenseToDelete);
            showConfirmationModal();
        }

        // Show confirmation modal
        function showConfirmationModal() {
            document.getElementById('confirmationModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close confirmation modal
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            expenseToDelete = null;
        }

        // Get CSRF token
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                return token.value;
            }
            // Fallback: get from cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return null;
        }

        // Confirm delete action
        function confirmDelete() {
            console.log('confirmDelete called, expenseToDelete:', expenseToDelete);

            if (!expenseToDelete || Number.isNaN(expenseToDelete) || expenseToDelete <= 0) {
                console.error('Invalid expenseToDelete:', expenseToDelete);
                showToast('Error: No valid expense selected for deletion.', 'error');
                return;
            }

            // Capture id locally first because closeConfirmationModal() clears the global
            const idToDelete = expenseToDelete;

            // Close the confirmation UI immediately (this resets the global)
            closeConfirmationModal();

            // Show loading toast
            showToast('Deleting expense...', 'info');

            const csrfToken = getCSRFToken();
            console.log('CSRF Token:', csrfToken);
            if (!csrfToken) {
                showToast('CSRF token not found. Please refresh the page.', 'error');
                return;
            }

            // AJAX delete (POST) ‚Äî Django view expects int pk in URL
            fetch(`/delete/${idToDelete}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}`
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (response.ok) {
                    showToast('Expense deleted successfully!', 'success');
                    // Remove the expense card from DOM
                    const expenseCard = document.querySelector(`[data-expense-id="${idToDelete}"]`);
                    if (expenseCard) {
                        expenseCard.style.transition = 'all 0.3s ease';
                        expenseCard.style.transform = 'translateX(-100%)';
                        expenseCard.style.opacity = '0';
                        setTimeout(() => {
                            expenseCard.remove();
                            // Reload page to update stats
                            window.location.reload();
                        }, 300);
                    } else {
                        // If card not in DOM, reload to update UI
                        window.location.reload();
                    }
                } else {
                    return response.text().then(text => {
                        // Try to show server error if available
                        let msg = 'Failed to delete expense.';
                        try { msg = JSON.parse(text).error || msg; } catch(e) {}
                        showToast(msg, 'error');
                    });
                }
            })
            .catch(error => {
                console.error('AJAX Error:', error);
                console.log('Falling back to form submission...');

                // Fallback to form submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/delete/${idToDelete}/`;

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();
            });
        }

        // Toast notification system
        function showToast(message, type = 'info', title = '') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info'
            };
            
            toast.innerHTML = `
                <div class="toast-icon ${type}">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            const incomeDateInput = document.getElementById('income_date');
            const today = new Date().toISOString().split('T')[0];
            if (dateInput) dateInput.value = today;
            if (incomeDateInput) incomeDateInput.value = today;

            // Search date input helper to hide browser placeholder text like "dd-mm-yyyy"
            const searchDate = document.querySelector('input[name="date"]');
            if (searchDate) {
                // mark initial state
                if (searchDate.value) searchDate.classList.add('has-value');
                // toggles when user picks a date
                searchDate.addEventListener('change', function() {
                    if (this.value) this.classList.add('has-value'); else this.classList.remove('has-value');
                });
                // show on focus (so user sees value while editing)
                searchDate.addEventListener('focus', function() { this.classList.add('has-value'); });
                searchDate.addEventListener('blur', function() { if (!this.value) this.classList.remove('has-value'); });
            }

            // Profile dropdown toggle (opens/closes dropdown and closes on outside click)
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });

                document.addEventListener('click', function(e) {
                    if (!profileDropdown.classList.contains('hidden') && !profileBtn.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }

            // Random emoji avatar: choose once and persist to localStorage for consistency
            const emojiEl = document.getElementById('profileEmoji');
            if (emojiEl) {
                const storageKey = 'extrack_profile_emoji';
                const available = ['üíº','üí∞','üí∏','ü™ô','üìà','üìä','üßæ','üè¶','ü´∞','‚ú®','üåü','üòä','üòé','ü™Ñ','ü¶Ñ','üéØ','üèÜ'];
                let chosen = null;
                try {
                    chosen = localStorage.getItem(storageKey);
                } catch (e) { /* ignore storage errors */ }

                if (!chosen) {
                    chosen = available[Math.floor(Math.random() * available.length)];
                    try { localStorage.setItem(storageKey, chosen); } catch (e) {}
                }

                emojiEl.textContent = chosen;
                emojiEl.setAttribute('title', '{{ user.username }}');
            }
            
            // Debug: Check if there are any expense cards
            const expenseCards = document.querySelectorAll('[data-expense-id]');
            console.log('Found expense cards:', expenseCards.length);
            expenseCards.forEach((card, index) => {
                const id = card.getAttribute('data-expense-id');
                console.log(`Card ${index}: ID = ${id}`);
            });
            
            // Debug: Check delete buttons (using data-expense-id)
            const deleteButtons = document.querySelectorAll('button[data-expense-id]');
            console.log('Found delete buttons:', deleteButtons.length);
            deleteButtons.forEach((button, index) => {
                const id = button.getAttribute('data-expense-id');
                console.log(`Button ${index}: data-expense-id = ${id}`);
            });
        });
    </script>
</body>
</html>